import{app}from"../../../scripts/app.js";import{api}from"../../../scripts/api.js";import{ComfyWidgets}from"../../../scripts/widgets.js";import{$el}from"../../../scripts/ui.js";const styleElement=document.createElement("style"),cssCode="\n    #msgDiv{\n      width:800px;\n      height: 200px;\n      text-align: center;\n      font-size: 30px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding-bottom: 40px;\n      color: var(--fg-color);\n    }\n    #qrCode{\n      display: block;\n      width:256px;\n      height:256px;\n      border-radius: 10px;\n    }\n    #qrBox{\n      display: block;\n      text-align: center;\n      display:flex;\n      flex-wrap: wrap;\n      justify-content: center;\n      width: 360px;\n    }\n    #qrDesc{\n      display: block;\n      text-align: center;\n      margin-top: 20px;\n      color: #ffffff;\n      width: 360px;\n    }\n    .codeImg {\n      // display: block;\n      width:256px;\n      height:256px;\n      border-radius: 10px;\n      padding: 10px;\n      border: 2px solid #ffffff;\n    }\n    .codeDesc {\n      display: block;\n      text-align: center;\n      margin-top: 20px;\n      color: #ffffff;\n      width: 360px;\n      font-size: 16px;\n    }\n    .codeDiv {\n      color: #ffffff;\n    }\n    .codeBox {\n      display: flex;\n      text-align: center;\n    }\n    #directions{\n      margin-top: 10px;\n      width: 100%;\n      text-align: left;\n      color: #ffffff;\n      font-size: 8px;\n    }\n    .tech_button {\n      flex:1;\n      height:30px;\n      border-radius: 8px;\n      border: 2px solid var(--border-color);\n      font-size:11px;\n      background:var(--comfy-input-bg);\n      color:var(--error-text);\n      box-shadow:none;\n      cursor:pointer;\n      width: 1rem;\n    }\n    #tech_box {\n      max-height: 80px;\n      display:flex;\n      flex-wrap: wrap;\n      align-items: flex-start;\n    }\n    .uniqueid {\n      display: none;\n    }\n    #showMsgDiv {\n      width:800px;\n      padding: 60px 0;\n      text-align: center;\n      font-size: 30px;\n      color: var(--fg-color);\n    }\n";styleElement.innerHTML=cssCode,document.head.appendChild(styleElement);var techsidkey="techsid"+window.location.port,loading=!1;const msgBox=$el("div.comfy-modal",{parent:document.body},[]),msgDiv=$el("div",{id:"msgDiv"},"");function setCookie(e,t,i=1){var s="";if(i){var o=new Date;o.setTime(o.getTime()+24*i*60*60*1e3),s="; expires="+o.toUTCString()}document.cookie=e+"="+(t||"")+s+"; path=/"}function getCookie(e){for(var t=e+"=",i=document.cookie.split(";"),s=0;s<i.length;s++){for(var o=i[s];" "==o.charAt(0);)o=o.substring(1,o.length);if(0==o.indexOf(t))return o.substring(t.length,o.length)}return""}function generateTimestampedRandomString(){return(Date.now().toString(36)+Array(3).fill(0).map((()=>Math.random().toString(36).substring(2))).join("").substring(0,18)).substring(0,32)}function showLoading(e=""){hideLoading(),msgDiv.innerText=e||"ËØ∑Á®çÂêé...",msgBox.style.display="block",loading=!0}function hideLoading(){msgBox.style.display="none",loading=!1}function showToast(e="",t=0){t=t>0?t:2e3,msgDiv.innerText=e||"Ë∞¢Ë∞¢",msgBox.style.display="block",setTimeout((()=>{msgBox.style.display="none"}),t)}msgBox.appendChild(msgDiv),msgBox.style.display="none",msgBox.style.zIndex=10001;var serverUrl=window.location.href;const qrCode=$el("img",{id:"qrCode",src:"",onerror:()=>{}}),qrDesc=$el("div",{id:"qrDesc"},"ËØ∑Áî®ÂæÆ‰ø°Êâ´Á†ÅÔºåÈ™åËØÅË∫´‰ªΩ..."),qrBox=$el("div",{id:"qrBox"},[qrCode,qrDesc]);app.ui.dialog.element.style.zIndex=10010;const showMsgDiv=$el("div",{id:"showMsgDiv"},"ËØ∑Á®çÂêé...");function showCodeBox(e){app.ui.dialog.close();let t=[];for(let i=0;i<e.length;i++)t.push($el("div.codeDiv",{},[$el("img.codeImg",{src:e[i].code}),$el("div.codeDesc",{},e[i].desc)]));const i=$el("div.codeBox",{},t);app.ui.dialog.show(i)}function showQrBox(e,t){app.ui.dialog.close(),qrDesc.innerText=t,qrCode.src=e,app.ui.dialog.show(qrBox)}function hideCodeBox(){app.ui.dialog.close()}function showMsg(e){app.ui.dialog.close(),showMsgDiv.innerText=e,app.ui.dialog.show(showMsgDiv)}function hideMsg(){app.ui.dialog.close()}function tech_alert(e){loading=!1,showMsg(e)}function getPostData(e){const t=e.output;console.log(t);let i=0,s={},o={},n={},d=[];for(const e in t)"sdBxb"==t[e].class_type&&(s=t[e].inputs,i++),"SaveImage"!=t[e].class_type&&"VHS_VideoCombine"!=t[e].class_type||(t[e].res_node=e,d.push(t[e]));if(i>1)return"Â∑•‰ΩúÊµÅ‰∏≠Âè™ÂèØ‰ª•Â≠òÂú®1‰∏™‚ÄúSDÂèòÁé∞ÂÆù‚ÄùËäÇÁÇπ";if(d.length<1)return"ËØ∑Á°Æ‰øùÂ∑•‰ΩúÊµÅ‰∏≠Êúâ‰∏î‰ªÖÊúâ1‰∏™‚ÄúSaveImgae‚ÄùÊàñ‚ÄúVHS_VideoCombine‚ÄùËäÇÁÇπÔºåÁõÆÂâçÊúâ"+d.length+"‰∏™";if(d.length>1)return"ËØ∑Á°Æ‰øùÂ∑•‰ΩúÊµÅ‰∏≠Êúâ‰∏î‰ªÖÊúâ1‰∏™‚ÄúSaveImgae‚ÄùÊàñ‚ÄúVHS_VideoCombine‚ÄùËäÇÁÇπÔºåÁõÆÂâçÊúâ"+d.length+"‰∏™";if(n.res_node=d[0].res_node,s){if(o.zhutu1=s["app_img1(optional)"],o.zhutu2=s["app_img2(optional)"],o.zhutu3=s["app_img3(optional)"],o.cs_img1=s["custom_img1(optional)"],o.cs_img2=s["custom_img2(optional)"],o.cs_img3=s["custom_img3(optional)"],o.cs_video1=s["custom_video1(optional)"],o.cs_video2=s["custom_video2(optional)"],o.cs_video3=s["custom_video3(optional)"],o.cs_text1=s["custom_text1(optional)"],o.cs_text2=s["custom_text2(optional)"],o.cs_text3=s["custom_text3(optional)"],o.title=s.app_title,o.gn_desc=s.app_desc,o.sy_desc="‰ΩúÂìÅ‰ΩøÁî®ËØ¥Êòé",o.server=serverUrl,o.fee=s.app_fee,o.free_times=s.free_times,o.cs_img1_desc=s.custom_img1_desc,o.cs_img2_desc=s.custom_img2_desc,o.cs_img3_desc=s.custom_img3_desc,o.cs_video1_desc=s.custom_video1_desc,o.cs_video2_desc=s.custom_video2_desc,o.cs_video3_desc=s.custom_video3_desc,o.cs_text1_desc=s.custom_text1_desc,o.cs_text2_desc=s.custom_text2_desc,o.cs_text3_desc=s.custom_text3_desc,o.uniqueid=s.uniqueid,n.zhutus=[],o.zhutu1){if("LoadImage"!=t[o.zhutu1[0]].class_type)return"‚Äúapp_img1‚ÄùÂè™ÂèØ‰ª•ËøûÊé•‚ÄúLoadImage‚ÄùËäÇÁÇπ";t[o.zhutu1[0]].inputs.image&&n.zhutus.push(t[o.zhutu1[0]].inputs.image)}if(o.zhutu2){if("LoadImage"!=t[o.zhutu2[0]].class_type)return"‚Äúapp_img2‚ÄùÂè™ÂèØ‰ª•ËøûÊé•‚ÄúLoadImage‚ÄùËäÇÁÇπ";t[o.zhutu2[0]].inputs.image&&n.zhutus.push(t[o.zhutu2[0]].inputs.image)}if(o.zhutu3){if("LoadImage"!=t[o.zhutu3[0]].class_type)return"‚Äúapp_img3‚ÄùÂè™ÂèØ‰ª•ËøûÊé•‚ÄúLoadImage‚ÄùËäÇÁÇπ";t[o.zhutu3[0]].inputs.image&&n.zhutus.push(t[o.zhutu3[0]].inputs.image)}if(n.cs_img_nodes=[],o.cs_img1){if("LoadImage"!=t[o.cs_img1[0]].class_type)return"‚Äúcustom_img1‚ÄùÂè™ÂèØ‰ª•ËøûÊé•‚ÄúLoadImage‚ÄùËäÇÁÇπ";n.cs_img_nodes.push({node:o.cs_img1[0],desc:o.cs_img1_desc})}if(o.cs_img2){if("LoadImage"!=t[o.cs_img2[0]].class_type)return"‚Äúcustom_img2‚ÄùÂè™ÂèØ‰ª•ËøûÊé•‚ÄúLoadImage‚ÄùËäÇÁÇπ";n.cs_img_nodes.push({node:o.cs_img2[0],desc:o.cs_img2_desc})}if(o.cs_img3){if("LoadImage"!=t[o.cs_img3[0]].class_type)return"‚Äúcustom_img3‚ÄùÂè™ÂèØ‰ª•ËøûÊé•‚ÄúLoadImage‚ÄùËäÇÁÇπ";n.cs_img_nodes.push({node:o.cs_img3[0],desc:o.cs_img3_desc})}if(n.cs_video_nodes=[],o.cs_video1){if("VHS_LoadVideo"!=t[o.cs_video1[0]].class_type)return"‚Äúcustom_video1‚ÄùÂè™ÂèØ‰ª•ËøûÊé•‚ÄúLoad Video (Upload) üé•üÖ•üÖóüÖ¢‚ÄùËäÇÁÇπ";n.cs_video_nodes.push({node:o.cs_video1[0],desc:o.cs_video1_desc})}if(o.cs_video2){if("VHS_LoadVideo"!=t[o.cs_video2[0]].class_type)return"‚Äúcustom_video2‚ÄùÂè™ÂèØ‰ª•ËøûÊé•‚ÄúLoad Video (Upload) üé•üÖ•üÖóüÖ¢‚ÄùËäÇÁÇπ";n.cs_video_nodes.push({node:o.cs_video2[0],desc:o.cs_video2_desc})}if(o.cs_video3){if("VHS_LoadVideo"!=t[o.cs_video3[0]].class_type)return"‚Äúcustom_video3‚ÄùÂè™ÂèØ‰ª•ËøûÊé•‚ÄúLoad Video (Upload) üé•üÖ•üÖóüÖ¢‚ÄùËäÇÁÇπ";n.cs_video_nodes.push({node:o.cs_video3[0],desc:o.cs_video3_desc})}if(n.cs_text_nodes=[],o.cs_text1){if(!t[o.cs_text1[0]]||void 0===t[o.cs_text1[0]].inputs||void 0===t[o.cs_text1[0]].inputs.text)return"‚Äúcustom_text1‚ÄùÂè™ÂèØ‰ª•ËøûÊé•‚ÄútextInput‚ÄùËäÇÁÇπ";n.cs_text_nodes.push({node:o.cs_text1[0],desc:o.cs_text1_desc})}if(o.cs_text2){if(!t[o.cs_text2[0]]||void 0===t[o.cs_text2[0]].inputs||void 0===t[o.cs_text2[0]].inputs.text)return"‚Äúcustom_text2‚ÄùÂè™ÂèØ‰ª•ËøûÊé•‚ÄútextInput‚ÄùËäÇÁÇπ";n.cs_text_nodes.push({node:o.cs_text2[0],desc:o.cs_text2_desc})}if(o.cs_text3){if(!t[o.cs_text3[0]]||void 0===t[o.cs_text3[0]].inputs||void 0===t[o.cs_text3[0]].inputs.text)return"‚Äúcustom_text3‚ÄùÂè™ÂèØ‰ª•ËøûÊé•‚ÄútextInput‚ÄùËäÇÁÇπ";n.cs_text_nodes.push({node:o.cs_text3[0],desc:o.cs_text3_desc})}return o.title?(n.title=o.title,o.gn_desc?(n.gn_desc=o.gn_desc,o.sy_desc?(n.sy_desc=o.sy_desc,o.server?(n.server=o.server,o.fee>=0?(n.fee=o.fee,o.free_times>=0?(n.free_times=o.free_times,n.uniqueid=o.uniqueid,n.output=t,n):"‚Äúfree_times‚Äù‰∏çËÉΩÂ∞è‰∫é0"):"‚Äúapp_fee‚Äù‰∏çËÉΩÂ∞è‰∫é0ÂàÜÔºåÂç≥0ÂÖÉ"):"Á®ãÂ∫èËøêË°åÂá∫ÈîôÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò"):"ËØ∑Â°´ÂÜô‰ΩúÂìÅ‰ΩøÁî®ËØ¥Êòé"):"‚Äúapp_desc‚Äù, ‰∏çÂèØ‰∏∫Á©∫ÔºåËØ∑Â°´ÂÜô‰ΩúÂìÅÂäüËÉΩ‰ªãÁªç"):"‚Äúapp_title‚Äù, ‰∏çÂèØ‰∏∫Á©∫ÔºåËØ∑Â°´ÂÜô‰ΩúÂìÅÊ†áÈ¢ò"}}async function requestExe(e,t){var i=getCookie(techsidkey);const s=await api.fetchApi("/manager/tech_zhulu",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({r:e,techsid:i,postData:t})});if(!s.ok)return void setTimeout((()=>{showToast("ÁΩëÁªúËøûÊé•Âá∫ÈîôÔºåËØ∑‰øùÊåÅÁîµËÑëËÅîÁΩë",3e3)}),300);return await s.json()}async function login(e){let t=await requestExe("comfyui.index.code",{s_key:e});return"none"!=app.ui.dialog.element.style.display?t.data.data.techsid.length>5?t.data.data.techsid:(await new Promise((e=>setTimeout(e,800))),await login(e)):void 0}async function request(e,t){showLoading("Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÂêé...");let i=await requestExe(e,t);if(41009!=i.errno)return hideLoading(),i;{let i=await requestExe("comfyui.index.code",{s_key:""});if(i){if(1==i.data.data.code){hideLoading(),showQrBox(i.data.data.data,i.data.data.desc);let s=await login(i.data.data.s_key);return hideCodeBox(),s?(setCookie(techsidkey,s),await request(e,t)):void 0}return void showToast(i.data.data.message)}}}app.registerExtension({name:"sdBxb",async beforeRegisterNodeDef(e,t,i){if("sdBxb"===t.name){const t=e.prototype.onNodeCreated;e.prototype.onNodeCreated=function(){const e=t?t?.apply(this,arguments):void 0,s=(this.widgets.findIndex((e=>"zhanwei"===e.name)),$el("button.tech_button",{textContent:"ÁÇπÊ≠§ÔºåÂ∑•‰ΩúÊµÅËΩ¨Â∞èÁ®ãÂ∫è/H5ÔºåÂπ∂Ëé∑ÂèñËÆøÈóÆÂú∞ÂùÄ",style:{},onclick:async()=>{if(!loading){hideCodeBox();try{let e=getPostData(await i.graphToPrompt());if(!e.output)return void tech_alert(e);try{let t=await request("comfyui.index.upload",e);t&&(1==t.data.data.code?showCodeBox(t.data.data.list):showMsg(t.data.data.message))}catch(e){hideLoading()}}catch(e){return console.log(e),void tech_alert("Ëé∑ÂèñapiÊï∞ÊçÆÂ§±Ë¥•")}}}})),o=$el("div",{id:"directions"},["ÁâπÊÆäËØ¥ÊòéÔºö",$el("br"),"1„ÄÅÊØèÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑ‚ÄúSDÂèòÁé∞ÂÆù‚ÄùËäÇÁÇπÔºåÂ∞±ÂØπÂ∫î‰∏Ä‰∏™Êñ∞ÁöÑ‰ΩúÂìÅÔºõ",$el("br"),"2„ÄÅÂ¶ÇÊúâÈóÆÈ¢òÔºåËØ∑Âä†ÂÆòÊñπQQÁæ§Ôºö967073981ÔºåËÅîÁ≥ª‰ΩúËÄÖÂí®ËØ¢„ÄÇ",$el("br"),"3„ÄÅËßÜÈ¢ëÊïôÁ®ãÔºöhttps://www.bilibili.com/video/BV1Bsg8eeEjv"]),n=$el("div",{id:"tech_box"},[s,o]);this.addDOMWidget("select_styles","btn",n);const d=document.createElement("input");return d.setAttribute("type","text"),d.setAttribute("list","uedynamiclist"),d.setAttribute("value",generateTimestampedRandomString()),d.className="uniqueid",this.addDOMWidget("uniqueid","input",d,{getValue:()=>d.value,setValue(e){d.value=e}}),setTimeout((()=>{this.setSize([420,500])}),200),e},e.prototype.onRemoved=function(){},this.serialize_widgets=!0}}});